###############################################################################
# systemd system.conf
# High concurrency TCP server tuning (Ubuntu 22.04)
###############################################################################

[Manager]

########################
# 文件描述符 & 进程资源
########################

# 全局默认最大文件描述符（非常关键）
DefaultLimitNOFILE=1048576

# 防止 fork 风暴拖垮系统（按规模可再调）
DefaultLimitNPROC=262144

# core dump：生产环境建议限制或关闭
DefaultLimitCORE=0

########################
# 内存 & OOM 行为
########################

# systemd 自身不参与 OOM 竞争（保护 PID 1）
OOMScoreAdjust=-1000

# 默认不限制服务内存（由 cgroup v2 动态管理）
DefaultMemoryAccounting=yes
DefaultTasksAccounting=yes
DefaultCPUAccounting=yes
DefaultIOAccounting=no

########################
# 超时：避免假死，提升 HA 自愈
########################

# 服务启动超时（复杂服务给足时间）
DefaultTimeoutStartSec=90s

# 停止超时：避免 shutdown 卡死
DefaultTimeoutStopSec=30s

# 重启前等待时间（防止抖动）
RestartSec=5s

########################
# Kill 行为（避免误杀整个进程组）
########################

# 只杀主进程，避免把 worker / sidecar 一起干掉
KillMode=process

# 先 SIGTERM，超时再 SIGKILL
KillSignal=SIGTERM
SendSIGKILL=yes
SendSIGHUP=no

########################
# 日志（高并发服务非常重要）
########################

# 不阻塞业务进程
LogLevel=info
LogTarget=journal

# 避免 journald 同步写放大
DefaultStandardOutput=journal
DefaultStandardError=journal

########################
# 资源控制默认值（偏宽松）
########################

# 不给 CPU 默认限制（由调度器决定）
DefaultCPUQuota=

# I/O 不限（高吞吐网络服务）
DefaultIOWeight=

########################
# 其它稳定性增强
########################

# systemd 自身 watchdog（增强 PID1 稳定性）
RuntimeWatchdogSec=30s
ShutdownWatchdogSec=10s

###############################################################################
# End of file
###############################################################################
