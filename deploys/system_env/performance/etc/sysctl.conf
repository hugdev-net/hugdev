###############################################################################
# Ubuntu 22.04 - High concurrency TCP server tuning
# Apply: sudo sysctl --system
###############################################################################

########## 基础：文件句柄与 inotify（避免高并发下资源不足）
fs.file-max = 2097152
fs.nr_open  = 2097152
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 1048576

########## 内核调度/性能：减少 debug 噪音与提升稳定性
kernel.printk = 3 4 1 3
kernel.panic = 10
kernel.panic_on_oops = 1
vm.swappiness = 10
vm.max_map_count = 262144

########## 网络：队列/缓冲（吞吐与抗突发）
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 250000
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.core.rmem_default = 1048576
net.core.wmem_default = 1048576
net.core.optmem_max = 25165824

# 自动调优窗口（一般建议开启并给足上限）
net.ipv4.tcp_rmem = 4096 1048576 33554432
net.ipv4.tcp_wmem = 4096 1048576 33554432

########## TCP：连接建立与拥塞控制（服务端常用）
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_syn_retries = 5
net.ipv4.tcp_synack_retries = 3
net.ipv4.tcp_syncookies = 1

# Keepalive：更快发现死连接（适合长连接场景，按需调）
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5

# TIME_WAIT/端口：提升高并发短连接承载
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 10240 65535

# 降低 FIN-WAIT-2 悬挂风险（避免大量半关闭连接拖垮）
net.ipv4.tcp_fin_timeout = 15

# 连接溢出时的行为：让问题“可观测”，而不是静默
net.ipv4.tcp_abort_on_overflow = 0

# 关闭过时/有风险功能（Ubuntu 22.04 默认也多为合理）
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1

########## 路由与 ARP：多网卡/容器/漂移 IP 常见（按需）
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

########## 安全与抗攻击：基本的反向路径与 ICMP 限制（按需）
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.tcp_rfc1337 = 1
